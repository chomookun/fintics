<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<th:block layout:fragment="_content">
    <script th:inline="javascript">
        // defines
        const brokers = new duice.ArrayProxy(/*[[${brokers}]]*/[]);
        const profitSearchMap = new Map();
        const profitMap = new Map();
        brokers.forEach(broker => {
            const profitSearch = new duice.ObjectProxy({
                _status: null
            });
            profitSearchMap.set(broker.brokerId, profitSearch);
            const profit = new duice.ObjectProxy({
                profitAmount: null,
                realizedProfitAmount: null,
                dividendProfitAmount: null,
                realizedProfits: [],
                dividendProfits: []
            });
            profitMap.set(broker.brokerId, profit);
        });

        function getProfit(brokerId, dateFrom, dateTo) {
            let url = new URL(`${_apiUrl}/v1/profits/${brokerId}`, document.location.origin);
            if (dateFrom && dateTo) {
                url.searchParams.set('dateFrom', dateFns.format(dateFrom, 'YYYY-MM-DD'));
                url.searchParams.set('dateTo', dateFns.format(dateTo, 'YYYY-MM-DD'));
            }
            let profitSearch = profitSearchMap.get(brokerId);
            profitSearch._status = 'loading';
            duice.ObjectProxy.clear(profitMap.get(brokerId));
            _fetch(url, {}, true)
            .then(response => response.json())
            .then(data => {
                duice.ObjectProxy.assign(profitMap.get(brokerId), data);
            })
            .finally(() => {
                profitSearch._status = 'completed';
            });
        }

        function getProfits(dateFrom, dateTo) {
            brokers.forEach(broker => {
                getProfit(broker.brokerId, dateFrom, dateTo);
            });
        }

        function getProfitsDaily() {
            getProfits(dateFns.subDays(new Date(), 1), new Date());
            toggleButton('daily');
        }

        function getProfitsWeekly() {
            getProfits(dateFns.subWeeks(new Date(), 1), new Date());
            toggleButton('weekly');
        }

        function getProfitsMonthly() {
            getProfits(dateFns.subMonths(new Date(), 1), new Date());
            toggleButton('monthly');
        }

        function getProfitsQuarterly() {
            getProfits(dateFns.subMonths(new Date(), 3), new Date());
            toggleButton('quarterly');
        }

        function getProfitsSemiannually() {
            getProfits(dateFns.subMonths(new Date(), 6), new Date());
            toggleButton('semiannually');
        }

        function getProfitsYearly() {
            getProfits(dateFns.subYears(new Date(), 1), new Date());
            toggleButton('yearly');
        }

        function toggleButton(selectedButtonId) {
            let buttonIds = ['daily','weekly','monthly','quarterly', 'semiannually','yearly'];
            buttonIds.forEach(buttonId => {
                let buttonElement = document.getElementById(buttonId);
                if (buttonId === selectedButtonId) {
                    buttonElement.classList.add('selected-button');
                } else {
                    buttonElement.classList.remove('selected-button');
                }
            });
        }

        // event listener
        document.addEventListener('DOMContentLoaded', () => {
            getProfitsDaily();
        });
    </script>
    <style th:inline="css">
        .period-button {
            min-width: 5em;
            opacity: 0.5;
        }
        .selected-button {
            font-weight: bold;
            opacity: 1.0;
        }
    </style>

    <!-- ====================================== -->
    <!-- start: title                           -->
    <!-- ====================================== -->
    <h1 id="title">
        <img class="icon" th:src="@{/static/image/icon-profit.svg}" alt="realized-profit"/>
        <span data-th-text="#{fintics.Profit}"></span>
    </h1>
    <!-- ====================================== -->
    <!-- end: title                             -->
    <!-- ====================================== -->

    <!-- ====================================== -->
    <!-- start: search condition                -->
    <!-- ====================================== -->
    <div class="display--flex gap--1px margin-bottom--1px">
        <button id="daily" class="period-button" type="button" onclick="getProfitsDaily();">
            <span data-th-text="#{web.global.day}"></span>
        </button>
        <button id="weekly" class="period-button" type="button" onclick="getProfitsWeekly();">
            <span data-th-text="#{web.global.week}"></span>
        </button>
        <button id="monthly" class="period-button" type="button" onclick="getProfitsMonthly();">
            <span data-th-text="#{web.global.month}"></span>
        </button>
        <button id="quarterly" class="period-button" type="button" onclick="getProfitsQuarterly();">
            <span data-th-text="#{web.global.quarter}"></span>
        </button>
        <button id="semiannually" class="period-button" type="button" onclick="getProfitsSemiannually();">
            <span data-th-text="#{web.global.semiannual}"></span>
        </button>
        <button id="yearly" class="period-button" type="button" onclick="getProfitsYearly();">
            <span data-th-text="#{web.global.year}"></span>
        </button>
    </div>
    <!-- ====================================== -->
    <!-- end: search condition                  -->
    <!-- ====================================== -->

    <!-- ====================================== -->
    <!-- start: profit                          -->
    <!-- ====================================== -->
    <div class="display--grid grid-template-columns--12fr gap--1rem">
        <div th:each="broker : ${brokers}" class="grid-column--span-6 s__grid-column--span-12">
            <div class="panel">
                <div class="panel-title display--flex justify-content--space-between">
                    <h2>
                        <img class="icon" th:src="@{/static/image/icon-broker.svg}" alt="broker"/>
                        <span data-th-text="${broker.name}"></span>
                    </h2>
                    <div class="align-self--end padding-right--1em font-weight--bold">
                        <img class="icon" th:src="@{/static/image/icon-profit.svg}" alt="profit"/>
                        <span data-th-text="#{fintics.Profit.profitAmount}"></span>:
                        <span th:data-duice-bind="|profitMap.get('${broker.brokerId}')|"
                              data-duice-property="profitAmount"
                              th:data-duice-execute="|
                                let profitAmount = profitMap.get('${broker.brokerId}').profitAmount;
                                this.classList.toggle('color--green', profitAmount > 0);
                                this.classList.toggle('color--red', profitAmount < 0);
                              |"
                              data-duice-format="number()" class="number">
                            </span>
                    </div>
                </div>
                <div class="panel-content">
                    <!-- start: realized profit -->
                    <div>
                        <div>
                            <span data-th-text="#{fintics.Profit.realizedProfitAmount}" class="font-weight--bold"></span>:
                            <span th:data-duice-bind="|profitMap.get('${broker.brokerId}')|"
                                  data-duice-property="realizedProfitAmount"
                                  th:data-duice-execute="|
                                    let realizedProfitAmount = profitMap.get('${broker.brokerId}').realizedProfitAmount;
                                    this.classList.toggle('color--green', realizedProfitAmount > 0);
                                    this.classList.toggle('color--red', realizedProfitAmount < 0);
                                    |"
                                  data-duice-format="number()"
                                  class="font-weight--bold number"></span>
                        </div>
                        <div class="overflow--scroll box" style="max-height:200px;">
                            <table class="table border--none" style="min-width:100%;">
                                <colgroup>
                                    <col style="width:7em;"/>
                                    <col style="width:7em;"/>
                                    <col style="width:15em;"/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th data-th-text="#{fintics.RealizedProfit.date}"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.symbol}"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.name}"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.profitAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.profitPercentage}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.quantity}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.purchasePrice}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.purchaseAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.disposePrice}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.disposeAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.RealizedProfit.feeAmount}" class="text-align--right"></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:data-duice-bind="|profitMap.get('${broker.brokerId}').realizedProfits|" data-duice-loop="realizedProfit,status">
                                    <td>
                            <span data-duice-bind="realizedProfit"
                                  data-duice-property="date"
                                  data-duice-format="date('yyyy-MM-dd')" class="date"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="realizedProfit" data-duice-property="symbol" class="code"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="realizedProfit" data-duice-property="name"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="profitAmount" data-duice-format="number()"
                                              data-duice-execute="
                                              this.classList.toggle('color--green', realizedProfit.profitAmount > 0);
                                              this.classList.toggle('color--red', realizedProfit.profitAmount < 0);
                                              " class="font-weight--bold number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="profitPercentage" data-duice-format="number()"
                                              data-duice-execute="
                                              this.classList.toggle('color--green', realizedProfit.profitPercentage > 0);
                                              this.classList.toggle('color--red', realizedProfit.profitPercentage < 0);
                                              " class="font-weight--bold number"></span>
                                        <span class="code">%</span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="quantity" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="purchasePrice" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="purchaseAmount" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="disposePrice" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="disposeAmount" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="realizedProfit" data-duice-property="feeAmount" data-duice-format="number()" class="number"></span>
                                    </td>
                                </tr>
                                <tr th:data-duice-bind="|profitSearchMap.get('${broker.brokerId}')|"
                                    th:data-duice-if="|return profitSearchMap.get('${broker.brokerId}')._status === 'loading'|" hidden>
                                    <td colspan="100%" class="text-align--center padding--1rem">
                                        <span class="blink" data-th-text="#{web.global.itemLoading(#{fintics.RealizedProfit})}"></span>
                                    </td>
                                </tr>
                                <tr th:data-duice-bind="|profitSearchMap.get('${broker.brokerId}')|"
                                    th:data-duice-if="|return profitSearchMap.get('${broker.brokerId}')._status == 'completed' && profitMap.get('${broker.brokerId}').realizedProfits.length < 1|" hidden>
                                    <td colspan="100%" class="text-align--center padding--1rem">
                                        <span data-th-text="#{web.global.itemNotFound(#{fintics.RealizedProfit})}"></span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- end: realized profit -->
                    <!-- start: dividend history -->
                    <div>
                        <div>
                            <span data-th-text="#{fintics.Profit.dividendProfitAmount}" class="font-weight--bold"></span>:
                            <span th:data-duice-bind="|profitMap.get('${broker.brokerId}')|"
                                  data-duice-property="dividendProfitAmount"
                                  data-duice-format="number()"
                                  th:data-duice-execute="|
                                  let dividendAmount = profitMap.get('${broker.brokerId}').dividendAmount;
                                  this.classList.toggle('color--green', dividendAmount > 0);
                                  this.classList.toggle('color--red', dividendAmount < 0);
                                  |"
                                  class="font-weight--bold number"></span>
                        </div>
                        <div class="overflow--scroll box" style="max-height:200px;">
                            <table class="table border--none" style="min-width:100%;">
                                <colgroup>
                                    <col style="width:7em;"/>
                                    <col style="width:7em;"/>
                                    <col style="width:15em;"/>
                                    <col/>
                                    <col/>
                                    <col style="width:7em;"/>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th data-th-text="#{fintics.DividendProfit.date}"></th>
                                    <th data-th-text="#{fintics.DividendProfit.symbol}"></th>
                                    <th data-th-text="#{fintics.DividendProfit.name}"></th>
                                    <th data-th-text="#{fintics.DividendProfit.dividendAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.DividendProfit.holdingQuantity}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.DividendProfit.paymentDate}"></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:data-duice-bind="|profitMap.get('${broker.brokerId}').dividendProfits|" data-duice-loop="dividendProfit,status">
                                    <td>
                                        <span data-duice-bind="dividendProfit"
                                              data-duice-property="date"
                                              data-duice-format="date('yyyy-MM-dd')" class="date"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="dividendProfit" data-duice-property="symbol" class="code"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="dividendProfit" data-duice-property="name"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="dividendProfit"
                                              data-duice-property="dividendAmount"
                                              data-duice-execute="
                                              this.classList.toggle('color--green', dividendProfit.dividendAmount > 0);
                                              this.classList.toggle('color--red', dividendProfit.dividendAmount < 0);
                                              "
                                              data-duice-format="number()"
                                              class="font-weight--bold number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="dividendProfit" data-duice-property="holdingQuantity" data-duice-format="number()" class="number"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="dividendProfit"
                                              data-duice-property="paymentDate"
                                              data-duice-format="date('yyyy-MM-dd')" class="date"></span>
                                    </td>
                                </tr>
                                <tr th:data-duice-bind="|profitSearchMap.get('${broker.brokerId}')|"
                                    th:data-duice-if="|return profitSearchMap.get('${broker.brokerId}')._status === 'loading'|">
                                    <td colspan="100%" class="text-align--center padding--1rem">
                                        <span class="blink" data-th-text="#{web.global.itemLoading(#{fintics.DividendProfit})}"></span>
                                    </td>
                                </tr>
                                <tr th:data-duice-bind="|profitSearchMap.get('${broker.brokerId}')|"
                                    th:data-duice-if="|return profitSearchMap.get('${broker.brokerId}')._status === 'completed' && profitMap.get('${broker.brokerId}').dividendProfits.length < 1;|" hidden>
                                    <td colspan="100%" class="text-align--center padding--1rem">
                                        <span data-th-text="#{web.global.itemNotFound(#{fintics.DividendProfit})}"></span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- end: dividend history -->
                </div>
            </div>
        </div>
    </div>
    <!-- ====================================== -->
    <!-- end: profit                            -->
    <!-- ====================================== -->

</th:block>
